<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4ade80; /* Green color for toggle */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4ade80; /* Green color for toggle */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-gray-800 shadow-lg">

        <!-- Header -->
        <header id="app-header" class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 p-4 flex items-center justify-between border-b border-gray-700">
            <button id="back-button" class="hidden text-gray-400 hover:text-white transition-colors">
                <i data-lucide="arrow-left"></i>
            </button>
            <h1 id="header-title" class="text-xl font-bold text-center text-white flex-grow">Dashboard</h1>
            <div class="w-8"></div> <!-- Spacer for balance -->
        </header>

        <main class="p-4 pb-20">

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                        <div class="flex items-center text-indigo-400">
                            <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                            <h3 class="text-sm font-medium">Units Consumed</h3>
                        </div>
                        <p class="text-2xl font-bold mt-2">124.5 kWh</p>
                    </div>
                    <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                         <div class="flex items-center text-green-400">
                            <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                            <h3 class="text-sm font-medium">Weekly Increase</h3>
                        </div>
                        <p class="text-2xl font-bold mt-2">+5.2%</p>
                    </div>
                </div>

                <!-- Daily Load Graph -->
                <div class="bg-gray-700 p-4 rounded-lg shadow-md mb-6">
                    <h3 class="text-lg font-semibold mb-3">Daily Load</h3>
                    <div class="h-48">
                       <canvas id="dailyLoadChart"></canvas>
                    </div>
                </div>

                <!-- Device Groups -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">Device Groups</h3>
                        <button id="add-group-btn" class="text-indigo-400 hover:text-indigo-300 text-sm font-semibold flex items-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i>
                            New Group
                        </button>
                    </div>
                    <div id="groups-list" class="grid grid-cols-2 gap-4">
                        <!-- Groups will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Rooms List -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Your Rooms</h3>
                    <div id="rooms-list" class="grid grid-cols-2 gap-4">
                        <!-- Rooms will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Room Page -->
            <div id="room-page" class="page">
                <div id="devices-list" class="grid grid-cols-2 gap-4">
                    <!-- Devices for the selected room will be inserted here -->
                </div>
                <button id="add-device-btn" class="mt-6 w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    Add Device
                </button>
            </div>

             <!-- Group Page -->
            <div id="group-page" class="page">
                <div class="bg-gray-700 p-4 rounded-lg shadow-md mb-6">
                    <h3 class="text-lg font-semibold mb-4">Group Controls</h3>
                    <div class="flex items-center justify-between mb-4">
                        <span class="font-bold text-md text-white">All Devices</span>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="group-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="group-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-500 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="gauge-circle" class="w-5 h-5 mr-3 text-gray-400"></i>
                        <input type="range" min="0" max="100" value="50" id="group-power-slider" class="range-slider w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                <div id="group-devices-list" class="space-y-2">
                    <!-- Devices in the group will be listed here -->
                </div>
            </div>

            <!-- Add/Edit Group Page -->
            <div id="edit-group-page" class="page">
                <div class="mb-4">
                    <label for="group-name" class="block text-sm font-medium text-gray-400 mb-2">Group Name</label>
                    <input type="text" id="group-name" placeholder="e.g. Movie Night" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                </div>
                <h3 class="text-md font-semibold mb-2">Select Devices</h3>
                <div id="group-device-selection" class="space-y-3 max-h-96 overflow-y-auto bg-gray-900 p-3 rounded-lg">
                    <!-- All devices will be listed here for selection -->
                </div>
                <button id="save-group-btn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    Save Group
                </button>
            </div>
            
            <!-- Add Device Page -->
            <div id="add-device-page" class="page">
                <h2 class="text-lg font-semibold mb-4">Add a New Device</h2>
                <div class="mb-6">
                    <label for="device-name" class="block text-sm font-medium text-gray-400 mb-2">Device Name</label>
                    <input type="text" id="device-name" placeholder="e.g. Study Lamp" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                </div>
                
                <h3 class="text-md font-semibold mb-3">Or use a template</h3>
                <div id="device-templates" class="grid grid-cols-2 gap-4">
                    <!-- Templates will be inserted here -->
                </div>
                 <button id="save-device-btn" class="mt-8 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    Save Device
                </button>
            </div>

            <!-- Custom TV Controller Page -->
            <div id="tv-controller-page" class="page">
                <div class="bg-gray-700 rounded-lg p-4">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold">TV Remote</h2>
                        <button class="w-12 h-12 bg-red-600 hover:bg-red-700 rounded-full flex items-center justify-center text-white">
                            <i data-lucide="power"></i>
                        </button>
                     </div>

                     <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-600 p-4 rounded-lg">
                            <p class="font-semibold mb-2">Volume</p>
                            <div class="flex justify-around items-center">
                                <button class="p-2 rounded-full bg-gray-800 hover:bg-gray-900"><i data-lucide="volume-2"></i></button>
                                <button class="p-2 rounded-full bg-gray-800 hover:bg-gray-900"><i data-lucide="volume-x"></i></button>
                                <button class="p-2 rounded-full bg-gray-800 hover:bg-gray-900"><i data-lucide="volume-1"></i></button>
                            </div>
                        </div>
                         <div class="bg-gray-600 p-4 rounded-lg">
                            <p class="font-semibold mb-2">Channel</p>
                            <div class="flex justify-around items-center">
                                <button class="p-2 rounded-full bg-gray-800 hover:bg-gray-900"><i data-lucide="chevron-up"></i></button>
                                <button class="p-2 rounded-full bg-gray-800 hover:bg-gray-900"><i data-lucide="chevron-down"></i></button>
                            </div>
                        </div>
                     </div>
                     <div class="mt-4">
                         <label for="source-select" class="block text-sm font-medium text-gray-400 mb-2">Source</label>
                         <select id="source-select" class="w-full bg-gray-600 text-white border-gray-500 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                             <option>HDMI 1</option>
                             <option>HDMI 2</option>
                             <option>AV</option>
                             <option>Screen Mirroring</option>
                         </select>
                     </div>
                </div>
            </div>
            
            <!-- Manufacturer's Custom Controller Page -->
            <div id="manufacturer-page" class="page">
                <div class="text-center py-10">
                    <i data-lucide="settings-2" class="w-16 h-16 mx-auto text-indigo-400 mb-4"></i>
                    <h2 class="text-xl font-bold mb-2">Manufacturer Controller</h2>
                    <p class="text-gray-400">This is a custom UI provided by the device manufacturer for advanced control.</p>
                    <div class="mt-6 bg-gray-700 p-6 rounded-lg text-left space-y-3">
                        <p><strong class="text-gray-300">Device Model:</strong> XYZ-SmartAC-2025</p>
                        <p><strong class="text-gray-300">Firmware:</strong> v3.1.4</p>
                        <button class="w-full mt-4 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Check for Updates</button>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            lucide.createIcons();

            const devicesWithPowerRegulation = ['light', 'ac', 'fan'];

            // --- STATE MANAGEMENT ---
            const state = {
                currentPage: 'dashboard-page',
                currentRoom: null,
                currentGroup: null,
                editingGroupId: null,
                rooms: [
                    { id: 1, name: 'Living Room', icon: 'sofa', devices: [
                        { id: 101, name: 'Main Lights', type: 'light', on: true, power: 80 },
                        { id: 102, name: 'Television', type: 'tv', on: false, power: 0 },
                        { id: 103, name: 'Air Conditioner', type: 'ac', on: true, power: 60 },
                    ]},
                    { id: 2, name: 'Bedroom', icon: 'bed-double', devices: [
                        { id: 201, name: 'Bedside Lamp', type: 'light', on: false, power: 0 },
                        { id: 202, name: 'Ceiling Fan', type: 'fan', on: true, power: 50 },
                    ]},
                    { id: 3, name: 'Kitchen', icon: 'chef-hat', devices: [
                        { id: 301, name: 'Overhead Light', type: 'light', on: true, power: 90 },
                    ]},
                    { id: 4, name: 'Office', icon: 'briefcase', devices: [
                         { id: 401, name: 'Desk Lamp', type: 'light', on: false, power: 0 },
                         { id: 402, name: 'Computer', type: 'custom', on: true, power: 100 },
                    ]}
                ],
                deviceTemplates: [
                    { name: 'Air Conditioner', type: 'ac', icon: 'air-vent' },
                    { name: 'Television', type: 'tv', icon: 'tv-2' },
                    { name: 'Ceiling Fan', type: 'fan', icon: 'wind' },
                    { name: 'Light Bulb', type: 'light', icon: 'lightbulb' }
                ],
                groups: [
                    { id: 1, name: 'Movie Time', icon: 'film', deviceIds: [101, 102] },
                    { id: 2, name: 'Good Night', icon: 'moon', deviceIds: [201, 202, 101] },
                ]
            };

            // --- DOM ELEMENTS ---
            const pages = document.querySelectorAll('.page');
            const headerTitle = document.getElementById('header-title');
            const backButton = document.getElementById('back-button');
            const roomsList = document.getElementById('rooms-list');
            const devicesList = document.getElementById('devices-list');
            const addDeviceBtn = document.getElementById('add-device-btn');
            const deviceTemplatesContainer = document.getElementById('device-templates');
            const saveDeviceBtn = document.getElementById('save-device-btn');
            const deviceNameInput = document.getElementById('device-name');
            const groupsList = document.getElementById('groups-list');
            const addGroupBtn = document.getElementById('add-group-btn');
            const groupNameInput = document.getElementById('group-name');
            const saveGroupBtn = document.getElementById('save-group-btn');

            // --- NAVIGATION ---
            const historyStack = ['dashboard-page'];

            function navigateTo(pageId, context = null) {
                if (state.currentPage !== pageId && state.currentPage !== 'navigating-back') {
                    historyStack.push(state.currentPage);
                }
                
                state.currentPage = pageId;

                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                backButton.classList.toggle('hidden', pageId === 'dashboard-page');

                switch (pageId) {
                    case 'dashboard-page':
                        headerTitle.textContent = 'Dashboard';
                        state.currentRoom = null;
                        state.currentGroup = null;
                        renderGroups();
                        renderRooms();
                        break;
                    case 'room-page':
                        state.currentRoom = context;
                        headerTitle.textContent = state.currentRoom.name;
                        renderDevices();
                        break;
                    case 'add-device-page':
                        headerTitle.textContent = `Add to ${state.currentRoom.name}`;
                        renderDeviceTemplates();
                        break;
                    case 'manufacturer-page':
                    case 'tv-controller-page':
                        headerTitle.textContent = context.name;
                        break;
                    case 'group-page':
                        state.currentGroup = context;
                        headerTitle.textContent = state.currentGroup.name;
                        renderGroupControls();
                        break;
                    case 'edit-group-page':
                        state.editingGroupId = context ? context.id : null;
                        headerTitle.textContent = context ? `Edit ${context.name}` : 'Create Group';
                        renderEditGroupPage();
                        break;
                }
                 lucide.createIcons();
            }

            backButton.addEventListener('click', () => {
                const previousPage = historyStack.pop();
                if (previousPage) {
                    state.currentPage = 'navigating-back'; 
                    let context = null;
                    if(previousPage === 'room-page'){ context = state.currentRoom; }
                    if(previousPage === 'group-page'){ context = state.currentGroup; }
                    navigateTo(previousPage, context);
                }
            });

            // --- RENDERING FUNCTIONS ---
            function renderRooms() {
                roomsList.innerHTML = '';
                state.rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    const onDevices = room.devices.filter(d => d.on).length;
                    roomElement.className = 'bg-gray-700 p-4 rounded-lg shadow-md flex flex-col items-start cursor-pointer hover:bg-gray-600 transition-colors';
                    roomElement.innerHTML = `
                        <div class="bg-indigo-600 p-2 rounded-full mb-3">
                            <i data-lucide="${room.icon}" class="w-6 h-6 text-white"></i>
                        </div>
                        <h4 class="font-bold text-md text-white">${room.name}</h4>
                        <p class="text-sm text-gray-400">${onDevices} of ${room.devices.length} on</p>
                    `;
                    roomElement.addEventListener('click', () => navigateTo('room-page', room));
                    roomsList.appendChild(roomElement);
                });
            }
            
            function renderGroups() {
                groupsList.innerHTML = '';
                state.groups.forEach(group => {
                    const groupElement = document.createElement('div');
                    groupElement.className = 'bg-gray-700 p-4 rounded-lg shadow-md flex flex-col items-start cursor-pointer hover:bg-gray-600 transition-colors';
                    groupElement.innerHTML = `
                        <div class="bg-purple-600 p-2 rounded-full mb-3">
                            <i data-lucide="${group.icon}" class="w-6 h-6 text-white"></i>
                        </div>
                        <h4 class="font-bold text-md text-white">${group.name}</h4>
                        <p class="text-sm text-gray-400">${group.deviceIds.length} devices</p>
                    `;
                    groupElement.addEventListener('click', () => navigateTo('group-page', group));
                    groupsList.appendChild(groupElement);
                });
            }

            function renderGroupControls() {
                const groupDevicesList = document.getElementById('group-devices-list');
                groupDevicesList.innerHTML = ' <h4 class="text-md font-semibold mb-2 text-gray-300">Devices in this group:</h4>';
                
                if (!state.currentGroup) return;

                const devicesInGroup = state.currentGroup.deviceIds.map(id => findDevice(id)).filter(d => d);

                devicesInGroup.forEach(device => {
                    const room = findRoomForDevice(device.id);
                    const deviceEl = document.createElement('div');
                    deviceEl.className = 'bg-gray-800 p-2 rounded-md flex justify-between items-center';
                    deviceEl.innerHTML = `
                        <div>
                            <span class="font-semibold text-white">${device.name}</span>
                            <span class="text-xs text-gray-400 ml-2">${room ? room.name : ''}</span>
                        </div>
                        <span class="text-sm ${device.on ? 'text-green-400' : 'text-gray-500'}">${device.on ? 'On' : 'Off'}</span>
                    `;
                    groupDevicesList.appendChild(deviceEl);
                });
            }

            function renderEditGroupPage() {
                const container = document.getElementById('group-device-selection');
                container.innerHTML = '';
                const group = state.editingGroupId ? state.groups.find(g => g.id === state.editingGroupId) : null;
                groupNameInput.value = group ? group.name : '';

                const checkedDeviceIds = group ? group.deviceIds : [];

                state.rooms.forEach(room => {
                    const roomHeader = document.createElement('h5');
                    roomHeader.className = "font-bold text-gray-300 mt-2 sticky top-0 bg-gray-900 py-1";
                    roomHeader.textContent = room.name;
                    container.appendChild(roomHeader);
                    
                    room.devices.forEach(device => {
                         const label = document.createElement('label');
                         label.className = 'flex items-center bg-gray-800 p-2 rounded-md cursor-pointer hover:bg-gray-700';
                         label.innerHTML = `
                            <input type="checkbox" data-device-id="${device.id}" class="w-5 h-5 rounded text-indigo-500 bg-gray-600 border-gray-500 focus:ring-indigo-600" ${checkedDeviceIds.includes(device.id) ? 'checked' : ''}>
                            <span class="ml-3 text-white">${device.name}</span>
                         `;
                         container.appendChild(label);
                    });
                });
            }
            
            function renderDevices() {
                devicesList.innerHTML = '';
                if (!state.currentRoom) return;

                state.currentRoom.devices.forEach(device => {
                    const deviceElement = document.createElement('div');

                    const deviceOnClass = device.on ? 'bg-green-800/40' : 'bg-gray-700';
                    const iconBgClass = device.on ? 'bg-green-500' : 'bg-indigo-600';
                    const statusText = device.on && devicesWithPowerRegulation.includes(device.type) ? `On - ${device.power}% Power` : (device.on ? 'On' : 'Off');
                    const statusTextColor = device.on ? 'text-green-400' : 'text-gray-400';

                    let powerSliderHTML = '';
                    if (devicesWithPowerRegulation.includes(device.type)) {
                        powerSliderHTML = `
                        <div class="flex items-center mt-3">
                            <i data-lucide="gauge-circle" class="w-5 h-5 mr-2 text-gray-400"></i>
                            <input type="range" min="0" max="100" value="${device.power}" data-device-id="${device.id}" class="range-slider w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                        `;
                    }
                    
                    deviceElement.className = `device-box ${deviceOnClass} p-4 rounded-lg shadow-md flex flex-col justify-between hover:bg-gray-600/80 transition-colors cursor-pointer`;
                    deviceElement.dataset.deviceId = device.id;
                    
                    deviceElement.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <div class="${iconBgClass} p-2 rounded-full transition-colors">
                                    <i data-lucide="${getDeviceIcon(device.type)}" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="relative inline-block w-10 mr-0 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="toggle-${device.id}" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${device.on ? 'checked' : ''}/>
                                    <label for="toggle-${device.id}" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-500 cursor-pointer"></label>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h4 class="font-bold text-md text-white">${device.name}</h4>
                                <p class="text-xs ${statusTextColor}">${statusText}</p>
                            </div>
                        </div>
                        <div class="space-y-2 mt-4 ${device.on ? '' : 'hidden'}">
                            ${powerSliderHTML}
                            <button class="custom-controller-btn w-full text-xs bg-gray-600 hover:bg-gray-500 text-gray-200 font-semibold py-2 px-2 rounded-lg transition-colors flex items-center justify-center" data-device-id="${device.id}">
                                <i data-lucide="sliders-horizontal" class="w-4 h-4 mr-2"></i>
                                Controller
                            </button>
                        </div>
                    `;
                    devicesList.appendChild(deviceElement);
                });
                lucide.createIcons();
                attachDeviceListeners();
            }
            
            function getDeviceIcon(type) {
                const template = state.deviceTemplates.find(t => t.type === type);
                return template ? template.icon : 'radio-receiver';
            }

            function renderDeviceTemplates() {
                deviceTemplatesContainer.innerHTML = '';
                state.deviceTemplates.forEach(template => {
                    const templateEl = document.createElement('button');
                    templateEl.className = 'device-template-btn bg-gray-700 p-4 rounded-lg flex flex-col items-center justify-center hover:bg-gray-600 transition-colors border-2 border-transparent focus:border-indigo-500 focus:outline-none';
                    templateEl.dataset.name = template.name;
                    templateEl.dataset.type = template.type;
                    templateEl.innerHTML = `
                        <i data-lucide="${template.icon}" class="w-8 h-8 mb-2 text-indigo-400"></i>
                        <span class="font-semibold text-sm">${template.name}</span>
                    `;
                    deviceTemplatesContainer.appendChild(templateEl);
                });
                lucide.createIcons();
                
                document.querySelectorAll('.device-template-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        deviceNameInput.value = btn.dataset.name;
                        document.querySelectorAll('.device-template-btn').forEach(b => b.classList.remove('border-indigo-500', 'bg-gray-600'));
                        btn.classList.add('border-indigo-500', 'bg-gray-600');
                    });
                });
            }

            // --- EVENT LISTENERS ---
            function attachDeviceListeners() {
                 document.querySelectorAll('.device-box').forEach(box => {
                    box.addEventListener('click', e => {
                        if (e.target.closest('button, input[type=range], label, input[type=checkbox]')) {
                            return;
                        }
                        const deviceId = box.dataset.deviceId;
                        const checkbox = document.getElementById(`toggle-${deviceId}`);
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                });

                document.querySelectorAll('.toggle-checkbox').forEach(toggle => {
                    toggle.addEventListener('change', (e) => {
                        const deviceId = parseInt(toggle.id.replace('toggle-',''));
                        const device = findDevice(deviceId);
                        if (device) {
                            device.on = e.target.checked;
                            if (!device.on) device.power = 0;
                            renderDevices();
                        }
                    });
                });

                document.querySelectorAll('.range-slider').forEach(slider => {
                    slider.addEventListener('input', (e) => {
                        const deviceId = parseInt(e.target.dataset.deviceId);
                        const device = findDevice(deviceId);
                        if (device) {
                            device.power = parseInt(e.target.value);
                            const deviceBox = slider.closest('[data-device-id]');
                            if (deviceBox) {
                                const powerText = deviceBox.querySelector('.text-xs');
                                if(powerText && device.on) {
                                    powerText.textContent = `On - ${device.power}% Power`;
                                }
                            }
                        }
                    });
                });

                document.querySelectorAll('.custom-controller-btn').forEach(button => {
                   button.addEventListener('click', (e) => {
                       const deviceId = parseInt(e.currentTarget.dataset.deviceId);
                       const device = findDevice(deviceId);
                       if (device) {
                           if (device.type === 'tv') {
                               navigateTo('tv-controller-page', { name: device.name });
                           } else {
                               navigateTo('manufacturer-page', { name: device.name });
                           }
                       }
                   });
                });
            }
            
            addDeviceBtn.addEventListener('click', () => navigateTo('add-device-page'));
            addGroupBtn.addEventListener('click', () => navigateTo('edit-group-page'));
            
            saveDeviceBtn.addEventListener('click', () => {
                const name = deviceNameInput.value.trim();
                const selectedTemplate = document.querySelector('.device-template-btn.border-indigo-500');
                if (name && state.currentRoom) {
                    const newDevice = { id: Date.now(), name: name, type: selectedTemplate ? selectedTemplate.dataset.type : 'custom', on: false, power: 0 };
                    state.currentRoom.devices.push(newDevice);
                    deviceNameInput.value = '';
                    if (selectedTemplate) { selectedTemplate.classList.remove('border-indigo-500', 'bg-gray-600'); }
                    navigateTo('room-page', state.currentRoom);
                }
            });

            saveGroupBtn.addEventListener('click', () => {
                const name = groupNameInput.value.trim();
                if (!name) return;
                
                const selectedCheckboxes = document.querySelectorAll('#group-device-selection input[type="checkbox"]:checked');
                const deviceIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.deviceId));

                if (state.editingGroupId) {
                    const group = state.groups.find(g => g.id === state.editingGroupId);
                    group.name = name;
                    group.deviceIds = deviceIds;
                } else {
                    const newGroup = { id: Date.now(), name, icon: 'users', deviceIds };
                    state.groups.push(newGroup);
                }
                navigateTo('dashboard-page');
            });
            
            document.getElementById('group-toggle').addEventListener('change', (e) => {
                 if (!state.currentGroup) return;
                 const turnOn = e.target.checked;
                 state.currentGroup.deviceIds.forEach(id => {
                     const device = findDevice(id);
                     if (device) {
                         device.on = turnOn;
                         if (!turnOn) device.power = 0;
                     }
                 });
                 renderGroupControls();
            });
            
            document.getElementById('group-power-slider').addEventListener('input', (e) => {
                if (!state.currentGroup) return;
                const power = parseInt(e.target.value);
                state.currentGroup.deviceIds.forEach(id => {
                    const device = findDevice(id);
                    if (device && device.on) {
                        device.power = power;
                    }
                });
            });


            // --- HELPERS ---
            function findDevice(deviceId) {
                for (const room of state.rooms) {
                    const device = room.devices.find(d => d.id === deviceId);
                    if (device) return device;
                }
                return null;
            }

            function findRoomForDevice(deviceId) {
                for (const room of state.rooms) {
                    if (room.devices.some(d => d.id === deviceId)) {
                        return room;
                    }
                }
                return null;
            }

            // --- CHART.JS SETUP ---
            const ctx = document.getElementById('dailyLoadChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 150);
            gradient.addColorStop(0, 'rgba(79, 70, 229, 0.5)');
            gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['12am', '3am', '6am', '9am', '12pm', '3pm', '6pm', '9pm'],
                    datasets: [{
                        label: 'kWh',
                        data: [0.5, 0.4, 0.8, 2.1, 1.5, 2.5, 3.0, 1.2],
                        backgroundColor: gradient, borderColor: '#4f46e5', borderWidth: 2,
                        pointBackgroundColor: '#fff', pointBorderColor: '#4f46e5', tension: 0.4, fill: true,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af' } },
                        x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
                    }
                }
            });

            // --- INITIALIZATION ---
            function init() {
                renderRooms();
                renderGroups();
                navigateTo('dashboard-page');
            }

            init();
        });
    </script>
</body>
</html>

